---
name: Fetch

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - '*-20*'

jobs:
  Fetch:
    env:
      GITHUB_REF: ${{ github.ref }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        day: [all]
        month: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
    steps:
      - name: Get branch
        run: echo "GITHUB_BRANCH=$(echo ${GITHUB_REF##*/})" >> $GITHUB_ENV
        shell: bash
      - name: Get pair
        run: echo "PAIR=$(echo ${GITHUB_BRANCH%%-*})" >> $GITHUB_ENV
        shell: bash
      - name: Get year
        run: echo "YEAR=$(echo ${GITHUB_REF##*-})" >> $GITHUB_ENV
        shell: bash
      - uses: actions/checkout@v2
      - uses: fx31337/fx-data-download-action@master
        with:
          Days: ${{ matrix.day }}
          Months: ${{ matrix.month }}
          Years: ${{ env.YEAR }}
          Pairs: ${{ env.PAIR }}
      - name: Print CSV files
        run: find . -name "*.csv" -print
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: CSV
          path: '**/*.csv'
  Push:
    runs-on: ubuntu-latest
    needs: [Fetch]
    steps:
      - uses: actions/checkout@v2
        with:
          persist-credentials: false
      - uses: actions/download-artifact@v2
        with:
          name: CSV
          path: .
      - name: Commit files
        env:
          COMMIT_MSG: Adds CSV files
          GIT_EMAIL: ${{ github.actor }}@users.noreply.github.com
          GIT_NAME: ${{ github.actor }}
        run: |
          git config --local core.autocrlf false
          git config --local user.email $GIT_EMAIL
          git config --local user.name $GIT_NAME
          git add **/*.csv && git add --renormalize **/*.csv
          git pull origin ${{ github.ref }} --autostash --rebase -X ours
          NO_PAGER=1 git status
          git commit --allow-empty -am "$COMMIT_MSG"
          NO_PAGER=1 git status
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          branch: ${{ github.ref }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Re-pull on failure
        if: ${{ failure() }}
        run: git pull origin ${{ github.ref }} --autostash --rebase -X ours
      - name: Re-push on failure
        if: ${{ failure() }}
        uses: ad-m/github-push-action@master
        with:
          branch: ${{ github.ref }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
